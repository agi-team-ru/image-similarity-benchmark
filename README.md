# Image Similarity Benchmark

Инструмент для оценки эффективности различных методов поиска семантически похожих изображений.

## Описание

Проект представляет собой фреймворк для сравнительного анализа (бенчмаркинга) различных методов определения семантической схожести изображений. Он позволяет оценить и сравнить различные подходы к поиску визуально и смыслово похожих изображений.



## Структура проекта

```
├── src/
│ ├── benchmark.py         # Основной скрипт бенчмаркинга
│ ├── dataset_params.py    # Параметры датасета
│ ├── dto.py               # Объекты передачи данных
│ ├── generate_dataset.py  # Генерация тестового датасета
│ ├── server.py            # Сервер для тестирования методов
│ ├── server_params.py     # Параметры сервера
│ └── utils.py             # Вспомогательные функции
```

## Установка

```bash
# Создание виртуального окружения
python -m venv .venv
# Активация окружения
source .venv/bin/activate
# Установка зависимостей
pip install -r requirements.txt
```

## Использование

1. Поместите ваш датасет в `./data/my_dataset`
2. В `src/dataset_params.py` укажите директорию датасета через переменную `ds_root_dir`
3. В `src/benchmark.py` настройте тестируемые методы через список `tested_methods`

### Запуск тестового сервера


```bash
source .venv/bin/activate
python ./src/server.py
```

### Запуск бенчмарка

```bash
source .venv/bin/activate
python ./src/benchmark.py
```

## Методы сравнения изображений

### Используемая модель
- CLIP (Chinese CLIP ViT-Base-Patch16)
- Модель: `OFA-Sys/chinese-clip-vit-base-patch16`

### Поддерживаемые методы
1. **Тестовые методы**
   - `ALWAYS_FALSE` - всегда возвращает 0.0
   - `ALWAYS_TRUE` - всегда возвращает 1.0
   - `ALWAYS_RANDOM` - возвращает случайное значение от 0 до 1

2. **Методы на основе нейросетей**
   - `LIB_SIMILARITIES` - сравнение с использованием CLIP
   - `THREAT_EXCHANGE` - альтернативная реализация на основе CLIP

## API Reference

### Формат запросов и ответов

#### Запрос (ImgSimilarityRequest)

```json
{
"images": ["base64_encoded_image_1", "base64_encoded_image_2"],
"options": {
"method": "lib_similarities"
}
}
```


#### Ответ (ImgSimilarityResponse)


```json
{
"score": 0.85
}
```

## Генерация тестового датасета

### Структура исходных данных
Исходные изображения должны быть названы по шаблону: `группа_номер.расширение`
Например:
- `cat_001.jpg`
- `cat_002.jpg`
- `dog_001.jpg`
- `dog_002.jpg`

### Принцип генерации пар
1. **Похожие изображения (score = 1.0)**:
   - Формируются из изображений одной группы
   - Для каждой группы создается `N * pairs_in_group_n_factor` пар

2. **Непохожие изображения (score = 0.0)**:
   - Формируются из изображений разных групп
   - Для каждого изображения создается `pairs_in_group_n_factor` пар

## Процесс бенчмаркинга

### Метрики оценки
- **F1 Score**: Оценка точности бинарной классификации
- **R2 Score**: Коэффициент детерминации
- **MSE Score**: Среднеквадратичная ошибка

### Формат результатов
Результаты сохраняются в CSV файл со следующими колонками:
- method: название метода
- image1, image2: пути к изображениям
- y_true: ожидаемая оценка схожести
- y_pred: предсказанная оценка схожести

### Конфигурация методов


```python
TestedMethod(
name="method_name", # Уникальное имя метода
endpoint="http://...", # URL эндпоинта
options={ # Параметры метода
"method": "lib_similarities"
    },
    threshold=0.7 # Порог для бинарной классификации
)
```

### Обработка ошибок
- Автоматический повтор запросов при ошибках
- Таймаут повтора: 3 секунды
- Таймаут запроса: 120 секунд

## Конфигурация сервера
- Endpoint: `/img-similarity`
- Port: 8888
- Уровень логирования: настраивается через `LOG_LEVEL` (по умолчанию INFO)

## Требования
- Python 3.8+
- pandas
- scikit-learn
- httpx
- FastAPI
- uvicorn
- Pillow
- transformers (для CLIP)

## Лицензия
MIT
